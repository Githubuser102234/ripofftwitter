<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ripoff Twitter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f2f2f2;
    }
    header {
      background: #1da1f2;
      color: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      font-size: 1.3rem;
      margin: 0;
    }
    #searchInput {
      flex: 1;
      margin-left: 12px;
      padding: 8px;
      border-radius: 20px;
      border: none;
    }
    #feed {
      padding: 8px;
    }
    .post {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .meta {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 8px;
    }
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .buttons button {
      flex: 1;
      min-width: 60px;
      padding: 6px;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-like { background: #e1f5fe; }
    .btn-like.liked { background: #81d4fa; }
    .btn-edit { background: #fff9c4; }
    .btn-delete { background: #ffcdd2; }
    .btn-comment { background: #dcedc8; }
    .btn-hashtag { background: #c8e6c9; }
    #auth, #postForm {
      background: white;
      padding: 12px;
      margin: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    input, textarea, button {
      font-size: 1rem;
    }
    input, textarea {
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background: #1da1f2;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px;
    }
    @media (max-width: 400px) {
      .buttons { flex-direction: column; }
    }
  </style>
</head>
<body>

  <header>
    <h1>Ripoff Twitter</h1>
    <input id="searchInput" type="text" placeholder="Search posts...">
  </header>

  <div id="auth">
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <input id="username" type="text" placeholder="Username (for sign up)">
    <button id="signupBtn">Sign Up</button>
    <button id="loginBtn">Log In</button>
    <button id="logoutBtn" style="display:none">Log Out</button>
    <p id="user-info"></p>
  </div>

  <div id="postForm" style="display:none">
    <textarea id="postText" placeholder="What's happening?" rows="3"></textarea>
    <button id="postBtn">Post</button>
  </div>

  <div id="feed"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import {
      getFirestore, doc, collection, addDoc, setDoc, query, orderBy,
      onSnapshot, updateDoc, deleteDoc, getDoc, serverTimestamp, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = { /* your config */ };
    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const auth = getAuth(), db = getFirestore(app);

    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const usernameInput = document.getElementById("username");
    const signupBtn = document.getElementById("signupBtn");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const postBtn = document.getElementById("postBtn");
    const postText = document.getElementById("postText");
    const userInfo = document.getElementById("user-info");
    const feed = document.getElementById("feed");
    const searchInput = document.getElementById("searchInput");

    let currentUser = null, currentProfile = null, allPosts = [];

    onAuthStateChanged(auth, async user => {
      currentUser = user;
      if (user) {
        logoutBtn.style.display = "block";
        loginBtn.style.display = signupBtn.style.display = "none";
        postText.parentNode.style.display = "block";
        const d = await getDoc(doc(db, "profiles", user.uid));
        currentProfile = d.exists() ? d.data() : null;
        userInfo.textContent = currentProfile ? `@${currentProfile.username}` : '';
        listenPosts();
      } else {
        logoutBtn.style.display = "none";
        loginBtn.style.display = signupBtn.style.display = "block";
        postText.parentNode.style.display = "none";
        userInfo.textContent = 'Not logged in';
        feed.innerHTML = '';
      }
    });

    signupBtn.onclick = async () => {
      const u = usernameInput.value.trim();
      if (!u) return alert("Username required");
      try {
        const cred = await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        await setDoc(doc(db, "profiles", cred.user.uid), { email: emailInput.value, username: u, createdAt: serverTimestamp() });
      } catch (e) { alert(e.message); }
    };

    loginBtn.onclick = async () => {
      try { await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value); }
      catch (e) { alert(e.message); }
    };

    logoutBtn.onclick = () => signOut(auth);

    postBtn.onclick = async () => {
      const text = postText.value.trim();
      if (!text || !currentUser || !currentProfile) return;
      try {
        const docRef = await addDoc(collection(db, "posts"), {
          content: text, userId: currentUser.uid, username: currentProfile.username,
          likes: [], comments: [], createdAt: serverTimestamp()
        });
        postText.value = "";
      } catch (e) { alert("Failed: " + e.message); }
    };

    function listenPosts() {
      const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
      onSnapshot(q, snap => {
        allPosts = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        renderPosts();
      });
    }

    searchInput.oninput = () => renderPosts(searchInput.value.toLowerCase());

    function renderPosts(filter='') {
      feed.innerHTML = '';
      allPosts.filter(p => p.content.toLowerCase().includes(filter) || p.username.toLowerCase().includes(filter))
        .forEach(p => feed.appendChild(createPostEl(p)));
    }

    function createPostEl(p) {
      const el = document.createElement("div"); el.className = "post";
      const liked = currentUser && p.likes.includes(currentUser.uid);
      const permalink = `${location.origin}${location.pathname}#${p.id}`;
      el.innerHTML = `
        <div class="meta"><strong>@${p.username}</strong> â€¢ <a href="${permalink}" class="btn-hashtag">#${p.id.slice(0, 6)}</a></div>
        <div>${p.content}</div>
        <div class="buttons">
          <button class="btn-like ${liked?'liked':''}" onclick="toggleLike('${p.id}')">${liked?'Unlike':'Like'} (${p.likes.length})</button>
          ${currentUser && p.userId===currentUser.uid ? `<button class="btn-edit" onclick="editPost('${p.id}','${escapeJS(p.content)}')">Edit</button><button class="btn-delete" onclick="deletePost('${p.id}')">Delete</button>` : ''}
        </div>
        <div class="comment-box">
          <input type="text" id="comment-${p.id}" placeholder="Reply...">
          <button class="btn-comment" onclick="addComment('${p.id}')">Reply</button>
          ${(p.comments||[]).map(c=>`<div class="comment"><strong>@${c.by}</strong>: ${c.text}</div>`).join('')}
        </div>`;
      return el;
    }

    window.toggleLike = async id => { /* same as before */ };
    window.editPost = async (id, text) => { /* same */ };
    window.deletePost = async id => { /* same */ };
    window.addComment = async id => { /* same */ };
    function escapeJS(s){ return s.replace(/'/g,"\\'").replace(/"/g,"&quot;"); }
  </script>
</body>
</html>